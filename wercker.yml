initial-build:
  box: python:3.6-slim
  steps:
    - install-packages:
      name: Install ssh
      packages: build-essential
    - script:
      name: Install virtualenv
      code: pip install virtualenv
    - virtualenv:
      name: Setup virtualenv
      python_location: /usr/local/bin/python
    - pip-install:
      clean_wheel_dir: true
    - script:
      name: Test CICD App
      code: pytest

  after-steps:
    - slack-notifier:
      channel: $SLACK_CHANNEL
      url: $SLACK_URL
      username: cicdbot

deploy-staging:
  box: ubuntu
  steps:
    - install-packages:
      name: Install ssh
      packages: openssh-server openssh-client
    - add-ssh-key:
      keyname: PKEY
    - add-to-known_hosts:
      hostname: 47.74.11.150
      fingerprint: SHA256:QB9bFGtW5EUCIArak1+AwzfWZLL63RIdN7FRc9TlDig
      type: rsa      
    - script:
      name: Install CICD app
      code: |
        ssh -tt tal@47.74.11.150 << EOF
           if [ -d "cicddemo" ]; then
               cd cicddemo && git pull
           else
               git clone git@bitbucket.org:talzeus/cicddemo.git cicddemo
           fi
           exit 0;
        EOF
        ssh -tt tal@47.74.11.150 'cd cicddemo && git pull'
        ssh -tt tal@47.74.11.150 'sudo pip install virtualenv'
        ssh -tt tal@47.74.11.150 'cd cicddemo && virtualenv --distribute env'
        ssh -tt tal@47.74.11.150 'cd cicddemo && source ./env/bin/activate && pip install -r requirements.txt'
        ssh -tt tal@47.74.11.150 'cd cicddemo && sudo cp ./cicd.service /etc/systemd/system'
        ssh -tt tal@47.74.11.150 'sudo systemctl start cicd'
        ssh -tt tal@47.74.11.150 'sudo systemctl enable cicd'
  after-steps:
    - slack-notifier:
      channel: $SLACK_CHANNEL
      url: $SLACK_URL
      username: cicdbot

prepare-production-image:
  box: python:2-slim
  steps:
    - telescreen/aliyun-build-ecs-image@0.1.0:
      name: Build ECS Image
      access_key_id: $ACCESS_KEY_ID
      access_key_secret: $ACCESS_KEY_SECRET
      instance_id: $INSTANCE_ID
      region_id: $REGION_ID
      image_name: ha-cicd-image
  after-steps:
    - slack-notifier:
      channel: $SLACK_CHANNEL
      url: $SLACK_URL
      username: cicdbot