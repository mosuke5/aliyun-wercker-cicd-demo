box: python:3.6-slim
initial-build:
  steps:
    # Install packages
    - script:
      name: Install packages
      code: |
        pip install virtualenv
        apt update
        apt install -y curl 
    - virtualenv:
      name: Setup virtualenv
      python_location: /usr/local/bin/python
      
    # This pip-install clears the local wheel cache
    - pip-install:
      clean_wheel_dir: true

    # A custom script step, name value is used in the UI
    # and the code value contains the command that get executed
    - script:
      name: echo python information
      code: |
        echo "python version $(python --version) running"
        echo "pip version $(pip --version) running"
    # Test app
    - script:
      name: test app
      code: pytest

  after-steps:
    - slack-notifier:
      channel: $SLACK_CHANNEL
      url: $SLACK_URL
      username: cicdbot

create-aliyun-image:
  steps:
    - script:
      name: Install aliyuncli
      code: |
        pip install aliyuncli
        pip install aliyun-python-sdk-slb aliyun-python-sdk-ecs
        pip install aliyun-python-sdk-rds aliyun-python-sdk-oss aliyun-python-sdk-r-kvstore
        pip install aliyun-python-sdk-sts aliyun-python-sdk-ess

deploy-staging:
  steps:
    - add-to-known_hosts:
      hostname: 47.74.11.150
      fingerprint: SHA256:3fCsEHjYaYKbvMT1Pei/PIKneoCnNx4WKRvwrEOZX+E.
    - add-ssh-key:
      keyname: $BITBUCKET_PRIVATEKEY
    - script:
      name: Clone and Update repository
      script:
        ssh -t tal@47.74.11.150 'git clone git@bitbucket.org:talzeus/cicddemo.git cicdapp'